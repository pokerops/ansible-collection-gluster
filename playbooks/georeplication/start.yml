---
- name: Load Gluster facts
  ansible.builtin.import_playbook: pokerops.gluster.facts
  vars:
    gluster_server_groupset: replica_start

- name: Get existing gluster geo replication volumes
  ansible.builtin.import_playbook: pokerops.gluster.georeplication.volumes

- name: Start geo replication session tasks
  hosts: "{{ gluster_server_prefix | default('gluster_server') }}_replica_start_master"
  gather_facts: false
  any_errors_fatal: true
  become: true
  vars:
    _gluster_volumes_statuses:
      - "Active"
      - "Passive"
  vars_files:
    - ../../vars/main.yml
  tasks:
    - name: End play when gluster georeplication is not required
      ansible.builtin.meta: end_play
      vars:
        _replicas: "{{ _gluster_server_slaves | default([]) }}"
      when: _replicas | length == 0

    - name: End play for unrequired gluster geo replication nodes
      ansible.builtin.meta: end_host
      when: (not inventory_hostname == (play_hosts | first))

    - name: Get gluster geo replication status
      ansible.builtin.shell: |
        gluster volume geo-replication status | awk \
        'NR>3 {print "{\"server\": \"" $1 "\", \"name\": \"" $2 "\", \"replica\": \"" $5 "\", \"status\": \"" $6"\"}"}'
      args:
        chdir: "/usr/sbin/"
      register: _georeplica_status
      changed_when: false
      tags: skip_ansible_lint

    - name: Set georeplication session status
      ansible.builtin.set_fact:
        _gluster_georeplica_sessions: "{{ _output }}"
        _gluster_user: "{{ _gluster_georeplica_user.name }}"
        _gluster_usergroup: "{{ _gluster_georeplica_group.name }}"
        _gluster_georeplica_volumes: "{{ _start_volumes }}"
      vars:
        _output: "{{ _georeplica_status.stdout_lines | default([]) | map('from_json') }}"
        _replicas: "{{ _output | rejectattr('status', 'in', _gluster_volumes_statuses) }}"
        _replica_names: "{{ _replicas | map(attribute='name') | unique }}"
        _target_volumes: "{{ _gluster_target_volumes | sort(attribute='name') }}"
        _volumes: "{{ _target_volumes | selectattr('name', 'in', _replica_names) }}"
        _start_volumes: "{{ _volumes | selectattr('state', 'equalto', 'present') }}"

    - name: Debug gluster geo replication status
      ansible.builtin.debug:
        msg: "{{ _gluster_georeplica_sessions }}"

    - name: Debug gluster geo replication volumes to start a session
      ansible.builtin.debug:
        msg: "{{ _gluster_georeplica_volumes }}"

    - name: End play when there are no geo replications to start
      ansible.builtin.meta: end_play
      when: _gluster_georeplica_volumes | length == 0

    - name: Verify gluster geo replication session status
      ansible.builtin.assert:
        that: _sessions | length > 0
      vars:
        _sessions: "{{ _gluster_georeplica_sessions }}"

    - name: Start geo replication session
      ansible.builtin.shell: |
        gluster volume geo-replication {{ _primary }} \
        {{ _gluster_user }}@{{ _replica }} start
      args:
        chdir: "/usr/sbin/"
      vars:
        _primary: "{{ item.name }}"
        _replica: "{{ item.replica_name }}"
      loop_control:
        label: "Primary: {{ _primary }} - Replica: {{ _replica }}"
      loop: "{{ _gluster_georeplica_volumes }}"
      register: _georeplica_start
      changed_when: false
      tags: skip_ansible_lint

    - name: Verify gluster geo replication session status
      ansible.builtin.assert:
        that: _status | rejectattr('stdout', 'match', '.*has been successful.*') | length == 0
      vars:
        _status: "{{ _georeplica_start.results | default([]) }}"

    - name: Get gluster geo replication status
      ansible.builtin.shell: |
        gluster volume geo-replication status | awk \
        'NR>3 {print "{\"server\": \"" $1 "\", \"name\": \"" $2 "\", \"replica\": \"" $5 "\", \"status\": \"" $6"\"}"}'
      vars:
        _results: "{{ _georeplica_status.stdout_lines | default([]) | map('from_json') }}"
        _volumes: "{{ _gluster_georeplica_volumes | map(attribute='name') }}"
        _query_volumes: "{{ _results | selectattr('name', 'in', _volumes) }}"
        _status: "{{ _query_volumes | rejectattr('status', 'in', _gluster_volumes_statuses) }}"
      args:
        chdir: "/usr/sbin/"
      register: _georeplica_status
      retries: "{{ _gluster_retries }}"
      delay: "{{ _gluster_delay }}"
      until: _status | length == 0
      changed_when: false
      tags: skip_ansible_lint

    - name: Set georeplication session status
      ansible.builtin.set_fact:
        _gluster_georeplica_sessions: "{{ _output | map('from_json') }}"
      vars:
        _output: "{{ _georeplica_status.stdout_lines | default([]) }}"

    - name: Debug gluster geo replication status
      ansible.builtin.debug:
        msg: "{{ _gluster_georeplica_sessions }}"

    - name: Verify gluster geo replication session status
      ansible.builtin.assert:
        that: ((_start_volumes | length) == (_volumes | length))
      vars:
        _sessions: "{{ _gluster_georeplica_sessions }}"
        _volumes: "{{ _gluster_georeplica_volumes }}"
        _volume_names: "{{ _volumes | map(attribute='name') }}"
        _volumes_status: "{{ _sessions | selectattr('status', 'in', _gluster_volumes_statuses) }}"
        _volume_status_names: "{{ _volumes_status | map(attribute='name') }}"
        _start_volumes: "{{ _volumes | selectattr('name', 'in', _volume_status_names) }}"
