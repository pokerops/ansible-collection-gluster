---
- name: Run Gluster facts
  ansible.builtin.import_playbook: pokerops.gluster.facts

- name: Get geo replication volume facts
  hosts: "{{ _gluster_georeplica_groupset }}"
  gather_facts: false
  vars:
    _gluster_georeplica_groupset: "{{ gluster_georeplica_groupset | default('gluster_replication_hosts') }}"
  vars_files:
    - ../../vars/main.yml
  tasks:
    - name: End play when gluster georeplication is not required
      ansible.builtin.meta: end_play
      vars:
        _replicas: "{{ groups[_gluster_georeplica_groupset] | default([]) }}"
      when: _replicas | length == 0

    - name: Set gluster replica volumes
      ansible.builtin.set_fact:
        _gluster_replica_volumes: "{{ _volumes_list }}"
      vars:
        _replica_state_default: "present"
        _volumes_num: "{{ _volumes | length }}"
        _replica_state_default_map: "{{ [_replica_state_default] * _volumes_num | int }}"
        _replica_state_default_dict: "{{ _replica_state_default_map | map(_to_dict, 'state') }}"
        _replica_member: "{{ groups[_gluster_georeplica_groupset] | sort | first }}"
        _volumes: "{{ _gluster_volumes | sort(attribute='name') }}"
        _volume_names: "{{ _volumes | map(attribute='name') }}"
        _volume_format: "{{ _volume_names | map(_map_format, _replica_member + '::%s') }}"
        _volume_dict: "{{ _volume_format | map(_to_dict, 'replica_name') }}"
        _volumes_combine: "{{ _volumes | zip(_volume_dict) | map('combine') }}"
        _volumes_list: "{{ _replica_state_default_dict | zip(_volumes_combine) | map('combine') }}"
      delegate_facts: true
      delegate_to: localhost

- name: Start geo replication session tasks
  hosts: "{{ _gluster_primary_groupset }}"
  gather_facts: false
  any_errors_fatal: true
  become: true
  vars:
    _gluster_primary_groupset: "{{ gluster_primary_groupset | default('gluster_primary_hosts') }}"
    _gluster_georeplica_groupset: "{{ gluster_georeplica_groupset | default('gluster_replication_hosts') }}"
    _gluster_volumes_statuses:
      - "Active"
      - "Passive"
  vars_files:
    - ../../vars/main.yml
  tasks:
    - name: End play when gluster georeplication is not required
      ansible.builtin.meta: end_play
      vars:
        _replicas: "{{ groups[_gluster_georeplica_groupset] | default([]) }}"
      when: _replicas | length == 0

    - name: Manage gluster replication member tasks
      run_once: true
      block:
        - name: Get gluster geo replication status
          ansible.builtin.shell: |
            gluster volume geo-replication status | awk \
            'NR>3 {print "{\"server\": \"" $1 "\", \"volume\": \"" $2 "\", \"replica\": \"" $5 "\", \"status\": \"" $6"\"}"}'
          args:
            chdir: "/usr/sbin/"
          register: _georeplica_status
          changed_when: false

        - name: Set georeplication session status
          ansible.builtin.set_fact:
            _gluster_georeplica_sessions: "{{ _output }}"
            _gluster_user: "{{ _gluster_georeplica_user.name }}"
            _gluster_usergroup: "{{ _gluster_georeplica_group.name }}"
            _gluster_georeplica_volumes: "{{ _start_volumes }}"
          vars:
            _output: "{{ _georeplica_status.stdout_lines | default([]) | map('from_json') }}"
            _existing_replicas: "{{ _output | map(attribute='volume') | unique }}"
            _replica_volumes: "{{ hostvars['localhost']['_gluster_replica_volumes'] | sort(attribute='name') }}"
            _primary_volumes: "{{ _gluster_volumes | sort(attribute='name') }}"
            _volumes_list: "{{ _replica_volumes | zip(_primary_volumes) | map('combine') }}"
            _volumes: "{{ _volumes_list | selectattr('name', 'in', _existing_replicas) }}"
            _start_volumes: "{{ _volumes | selectattr('state', 'equalto', 'present') }}"

        - name: Debug gluster geo replication status
          ansible.builtin.debug:
            msg: "{{ _gluster_georeplica_sessions }}"

        - name: Debug gluster geo replication volumes to start a session
          ansible.builtin.debug:
            msg: "{{ _gluster_georeplica_volumes }}"

        - name: Verify gluster geo replication session status
          ansible.builtin.assert:
            that: _sessions | length > 0
          vars:
            _sessions: "{{ _gluster_georeplica_sessions }}"

        - name: End play when there are no geo replications to start
          ansible.builtin.meta: end_play
          when: _gluster_georeplica_volumes | length == 0

        - name: Start geo replication session
          ansible.builtin.shell: |
            gluster volume geo-replication {{ _primary }} \
            {{ _gluster_user }}@{{ _replica }} start
          args:
            chdir: "/usr/sbin/"
          vars:
            _primary: "{{ item.name }}"
            _replica: "{{ item.replica_name }}"
          loop_control:
            label: "Primary: {{ _primary }} - Replica: {{ _replica }}"
          loop: "{{ _gluster_georeplica_volumes }}"
          register: _georeplica_start
          changed_when: false

        - name: Verify gluster geo replication session status
          ansible.builtin.assert:
            that: _status | rejectattr('stdout', 'match', '.*has been successful.*') | length == 0
          vars:
            _status: "{{ _georeplica_start.results | default([]) }}"

        - name: Get gluster geo replication status
          ansible.builtin.shell: |
            gluster volume geo-replication status | awk \
            'NR>3 {print "{\"server\": \"" $1 "\", \"volume\": \"" $2 "\", \"replica\": \"" $5 "\", \"status\": \"" $6"\"}"}'
          vars:
            _results: "{{ _georeplica_status.stdout_lines | default([]) | map('from_json') }}"
            _volumes: "{{ _gluster_georeplica_volumes | map(attribute='name') }}"
            _query_volumes: "{{ _results | selectattr('volume', 'in', _volumes) }}"
            _status: "{{ _query_volumes | rejectattr('status', 'in', _gluster_volumes_statuses) }}"
          args:
            chdir: "/usr/sbin/"
          register: _georeplica_status
          retries: "{{ _gluster_retries }}"
          delay: "{{ _gluster_delay }}"
          until: _status | length == 0
          changed_when: false

        - name: Set georeplication session status
          ansible.builtin.set_fact:
            _gluster_georeplica_sessions: "{{ _output | map('from_json') }}"
          vars:
            _output: "{{ _georeplica_status.stdout_lines | default([]) }}"

        - name: Debug gluster geo replication status
          ansible.builtin.debug:
            msg: "{{ _gluster_georeplica_sessions }}"

        - name: Verify gluster geo replication session status
          ansible.builtin.assert:
            that: ((_start_volumes | length) == (_volumes | length))
          vars:
            _sessions: "{{ _gluster_georeplica_sessions }}"
            _volumes: "{{ _gluster_georeplica_volumes }}"
            _volume_names: "{{ _volumes | map(attribute='name') }}"
            _volumes_status: "{{ _sessions | selectattr('status', 'in', _gluster_volumes_statuses) }}"
            _volume_status_names: "{{ _volumes_status | map(attribute='volume') }}"
            _start_volumes: "{{ _volumes | selectattr('name', 'in', _volume_status_names) }}"
